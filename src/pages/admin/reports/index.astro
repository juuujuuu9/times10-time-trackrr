---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { db } from '../../../db/index';
import { timeEntries, users, tasks, projects, clients } from '../../../db/schema';
import { count, sql, sum, gte, lte, and, eq } from 'drizzle-orm';
import { getProjectCosts, getClientCosts } from '../../../db/queries';

// Get the selected time period from query params, default to 'week'
const period = Astro.url.searchParams.get('period') || 'week';
// Get the selected view type from query params, default to 'project'
const viewType = Astro.url.searchParams.get('view') || 'project';
// Get the selected team member from query params, default to 'all'
const selectedTeamMember = Astro.url.searchParams.get('teamMember') || 'all';
// Get custom date range from query params
const customStartDate = Astro.url.searchParams.get('startDate');
const customEndDate = Astro.url.searchParams.get('endDate');

// Calculate date ranges based on selected period
const now = new Date();
let startDate: Date | null = null;
let endDate: Date | null = null;

switch (period) {
  case 'week':
    // This week (Sunday to Saturday)
    const dayOfWeek = now.getDay();
    const daysToSubtract = dayOfWeek === 0 ? 0 : dayOfWeek;
    startDate = new Date(now);
    startDate.setDate(now.getDate() - daysToSubtract);
    startDate.setHours(0, 0, 0, 0);
    endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    endDate.setHours(23, 59, 59, 999);
    break;
  case 'month':
    // This month
    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59, 999);
    break;
  case 'year':
    // Year to date
    startDate = new Date(now.getFullYear(), 0, 1);
    endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59, 999);
    break;
  case 'last30':
    // Last 30 days
    startDate = new Date(now);
    startDate.setDate(now.getDate() - 30);
    startDate.setHours(0, 0, 0, 0);
    endDate = new Date(now);
    endDate.setHours(23, 59, 59, 999);
    break;
  case 'custom':
    // Custom period - use provided dates or default to last 30 days
    if (customStartDate && customEndDate) {
      startDate = new Date(customStartDate);
      startDate.setHours(0, 0, 0, 0);
      endDate = new Date(customEndDate);
      endDate.setHours(23, 59, 59, 999);
    } else {
      // Default to last 30 days if no custom dates provided
      startDate = new Date(now);
      startDate.setDate(now.getDate() - 30);
      startDate.setHours(0, 0, 0, 0);
      endDate = new Date(now);
      endDate.setHours(23, 59, 59, 999);
    }
    break;
  default:
    // Default to week if invalid period
    const defaultDayOfWeek = now.getDay();
    const defaultDaysToSubtract = defaultDayOfWeek === 0 ? 0 : defaultDayOfWeek;
    startDate = new Date(now);
    startDate.setDate(now.getDate() - defaultDaysToSubtract);
    startDate.setHours(0, 0, 0, 0);
    endDate = new Date(startDate);
    endDate.setDate(startDate.getDate() + 6);
    endDate.setHours(23, 59, 59, 999);
}

// Build filter conditions
let filterConditions = [gte(timeEntries.startTime, startDate), lte(timeEntries.startTime, endDate)];

// Add team member filter if a specific member is selected
if (selectedTeamMember !== 'all') {
  filterConditions.push(eq(timeEntries.userId, parseInt(selectedTeamMember)));
}

const dateFilter = and(...filterConditions);

// Get all team members for the dropdown (sorted by first name)
const allTeamMembers = await db
  .select({
    id: users.id,
    name: users.name,
    email: users.email
  })
  .from(users)
  .orderBy(users.name);

// Get basic stats
const totalUsers = await db.select({ count: count() }).from(users);
const totalProjects = await db.select({ count: count() }).from(projects);
const totalTasks = await db.select({ count: count() }).from(tasks);

// Get total hours from time entries (with date filter)
const totalHoursResult = await db
  .select({
    totalSeconds: sql<number>`COALESCE(SUM(
      CASE 
        WHEN ${timeEntries.endTime} IS NOT NULL 
        THEN EXTRACT(EPOCH FROM (${timeEntries.endTime} - ${timeEntries.startTime}))
        ELSE COALESCE(${timeEntries.durationManual}, 0)
      END
    ), 0)`.as('total_seconds')
  })
  .from(timeEntries)
  .where(dateFilter);

// Get total cost from time entries (with date filter)
const totalCostResult = await db
  .select({
    totalCost: sql<number>`COALESCE(SUM(
      CASE 
        WHEN ${timeEntries.endTime} IS NOT NULL 
        THEN EXTRACT(EPOCH FROM (${timeEntries.endTime} - ${timeEntries.startTime})) / 3600 * COALESCE(${users.payRate}, 0)
        ELSE COALESCE(${timeEntries.durationManual}, 0) / 3600 * COALESCE(${users.payRate}, 0)
      END
    ), 0)`.as('total_cost')
  })
  .from(timeEntries)
  .innerJoin(users, sql`${timeEntries.userId} = ${users.id}`)
  .where(dateFilter);

// Get active team members (users with time entries, with date filter)
const activeTeamMembersResult = await db
  .select({
    count: count(sql`DISTINCT ${timeEntries.userId}`)
  })
  .from(timeEntries)
  .where(dateFilter);

// Get data based on view type
const teamMemberId = selectedTeamMember !== 'all' ? parseInt(selectedTeamMember) : undefined;
const projectCosts = viewType === 'project' ? await getProjectCosts(startDate, endDate, teamMemberId) : [];
const clientCosts = viewType === 'client' ? await getClientCosts(startDate, endDate, teamMemberId) : [];

// Format the data for display
const totalHours = totalHoursResult[0]?.totalSeconds || 0;
const totalCost = totalCostResult[0]?.totalCost || 0;
const activeTeamMembers = activeTeamMembersResult[0]?.count || 0;

// Format duration
const formatDuration = (seconds: number) => {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  return `${hours}h ${minutes}m`;
};

const formatDurationToHours = (seconds: number) => {
  return Math.round((seconds / 3600) * 100) / 100;
};

const totalHoursFormatted = formatDuration(totalHours);
const totalHoursDecimal = formatDurationToHours(totalHours);
const totalCostFormatted = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD'
}).format(totalCost);

// Get period display name
const getPeriodDisplayName = (period: string) => {
  switch (period) {
    case 'week': return 'This Week';
    case 'month': return 'This Month';
    case 'year': return 'Year to Date';
    case 'last30': return 'Last 30 Days';
    case 'custom': 
      if (customStartDate && customEndDate) {
        return `Custom Range (${new Date(customStartDate).toLocaleDateString()} - ${new Date(customEndDate).toLocaleDateString()})`;
      }
      return 'Last 30 Days';
    default: return 'This Week';
  }
};

const periodDisplayName = getPeriodDisplayName(period);

// Calculate max cost for chart scaling
const chartData = viewType === 'project' ? projectCosts : clientCosts;
const maxCost = chartData.length > 0 ? Math.max(...chartData.map(item => item.totalCost)) : 0;

// Format currency
const formatCurrency = (amount: number) => {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(amount);
};

// Get chart title and subtitle
const getChartTitle = () => {
  if (viewType === 'project') {
    return 'Costs per Project';
  } else {
    return 'Costs per Client';
  }
};

const getChartSubtitle = () => {
  if (viewType === 'project') {
    return `Cost breakdown by project for ${periodDisplayName.toLowerCase()}`;
  } else {
    return `Cost breakdown by client for ${periodDisplayName.toLowerCase()}`;
  }
};
---

<AdminLayout title="Reports" currentPage="reports">
  <div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-white">Reports & Analytics</h1>
        <p class="text-gray-300">Comprehensive insights into your time tracking data</p>
      </div>
      <div class="flex items-center space-x-4">
        <!-- Time Period Dropdown -->
        <div class="relative">
          <select 
            id="periodSelect" 
            class="appearance-none bg-gray-800 border border-gray-600 text-white px-4 py-2 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4F46E5] focus:border-transparent"
            onchange="handlePeriodChange(this.value)"
          >
            <option value="week" selected={period === 'week'}>This Week</option>
            <option value="month" selected={period === 'month'}>This Month</option>
            <option value="year" selected={period === 'year'}>Year to Date</option>
            <option value="last30" selected={period === 'last30'}>Last 30 Days</option>
            <option value="custom" selected={period === 'custom'}>Custom Range</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
            </svg>
          </div>
        </div>

        <!-- Custom Date Range Inputs -->
        <div id="customDateRange" class={`flex items-center space-x-2 ${period === 'custom' ? '' : 'hidden'}`}>
          <input 
            type="date" 
            id="startDate" 
            value={customStartDate || ''}
            class="bg-gray-800 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4F46E5] focus:border-transparent text-sm"
            placeholder="Start Date"
          />
          <span class="text-gray-400">to</span>
          <input 
            type="date" 
            id="endDate" 
            value={customEndDate || ''}
            class="bg-gray-800 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4F46E5] focus:border-transparent text-sm"
            placeholder="End Date"
          />
          <button 
            onclick="applyCustomRange()"
            class="bg-[#4F46E5] hover:bg-[#4338CA] text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors duration-200"
          >
            Apply
          </button>
        </div>

        <!-- View Type Dropdown -->
        <div class="relative">
          <select 
            id="viewSelect" 
            class="appearance-none bg-gray-800 border border-gray-600 text-white px-4 py-2 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4F46E5] focus:border-transparent"
            onchange="handleViewChange(this.value)"
          >
            <option value="project" selected={viewType === 'project'}>By Project</option>
            <option value="client" selected={viewType === 'client'}>By Client</option>
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
            </svg>
          </div>
        </div>

        <!-- Team Member Dropdown -->
        <div class="relative">
          <select 
            id="teamMemberSelect" 
            class="appearance-none bg-gray-800 border border-gray-600 text-white px-4 py-2 pr-8 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#4F46E5] focus:border-transparent"
            onchange="handleTeamMemberChange(this.value)"
          >
            <option value="all" selected={selectedTeamMember === 'all'}>All Team Members</option>
            {allTeamMembers.map((member) => (
              <option value={member.id} selected={selectedTeamMember === member.id.toString()}>
                {member.name}
              </option>
            ))}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">
            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
              <path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Period Info -->
    <div class="bg-gray-800 rounded-lg border border-gray-700 p-4">
      <p class="text-sm text-gray-300">
        <span class="font-medium">Showing data for:</span> {periodDisplayName}
        <span class="text-gray-400 ml-2">
          ({startDate.toLocaleDateString()} - {endDate.toLocaleDateString()})
        </span>
      </p>
    </div>

    <!-- Overview Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
      <div class="bg-gray-800 rounded-lg shadow border border-gray-700 p-6">
        <div class="flex items-center">
          <div class="p-2 bg-[#4F46E5] rounded-lg">
            <span class="text-2xl text-white">⏱️</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-400">Total Hours</p>
            <p class="text-2xl font-bold text-white">{totalHours > 0 ? totalHoursFormatted : '0h 0m'}</p>
            <p class="text-xs text-gray-500">{totalHours > 0 ? `${totalHoursDecimal} hours` : 'No time entries'}</p>
          </div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg shadow border border-gray-700 p-6">
        <div class="flex items-center">
          <div class="p-2 bg-[#10B981] rounded-lg">
            <span class="text-2xl text-white">💰</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-400">Total Cost</p>
            <p class="text-2xl font-bold text-white">{totalCost > 0 ? totalCostFormatted : '$0.00'}</p>
            <p class="text-xs text-gray-500">{totalCost > 0 ? 'Based on hourly rates' : 'No billable time'}</p>
          </div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg shadow border border-gray-700 p-6">
        <div class="flex items-center">
          <div class="p-2 bg-[#EC4899] rounded-lg">
            <span class="text-2xl text-white">📁</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-400">Total Projects</p>
            <p class="text-2xl font-bold text-white">{totalProjects[0]?.count || 0}</p>
          </div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg shadow border border-gray-700 p-6">
        <div class="flex items-center">
          <div class="p-2 bg-[#F59E0B] rounded-lg">
            <span class="text-2xl text-white">👤</span>
          </div>
          <div class="ml-4">
            <p class="text-sm font-medium text-gray-400">Active Team Members</p>
            <p class="text-2xl font-bold text-white">{activeTeamMembers}</p>
            <p class="text-xs text-gray-500">{activeTeamMembers > 0 ? 'Members with time entries' : 'No activity'}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Costs Chart -->
    {chartData.length > 0 && (
      <div class="bg-gray-800 rounded-lg shadow border border-gray-700 p-6">
        <div class="mb-6">
          <h3 class="text-lg font-medium text-white mb-2">{getChartTitle()}</h3>
          <p class="text-sm text-gray-400">{getChartSubtitle()}</p>
        </div>
        
        <div class="space-y-4">
          {viewType === 'project' ? (
            projectCosts.map((item, index) => (
              <div class="relative">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{item.projectName}</p>
                    <p class="text-xs text-gray-400">{item.clientName}</p>
                  </div>
                  <div class="text-right ml-4">
                    <p class="text-sm font-medium text-white">{formatCurrency(item.totalCost)}</p>
                    <p class="text-xs text-gray-400">{formatDurationToHours(item.totalHours)}h</p>
                  </div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                  <div 
                    class="bg-gradient-to-r from-[#4F46E5] to-[#7C3AED] h-3 rounded-full transition-all duration-300"
                    style={`width: ${maxCost > 0 ? (item.totalCost / maxCost) * 100 : 0}%`}
                  ></div>
                </div>
              </div>
            ))
          ) : (
            clientCosts.map((item, index) => (
              <div class="relative">
                <div class="flex items-center justify-between mb-2">
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{item.clientName}</p>
                    <p class="text-xs text-gray-400">{item.projectCount} projects</p>
                  </div>
                  <div class="text-right ml-4">
                    <p class="text-sm font-medium text-white">{formatCurrency(item.totalCost)}</p>
                    <p class="text-xs text-gray-400">{formatDurationToHours(item.totalHours)}h</p>
                  </div>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-3">
                  <div 
                    class="bg-gradient-to-r from-[#4F46E5] to-[#7C3AED] h-3 rounded-full transition-all duration-300"
                    style={`width: ${maxCost > 0 ? (item.totalCost / maxCost) * 100 : 0}%`}
                  ></div>
                </div>
              </div>
            ))
          )}
        </div>
        
        {chartData.length === 0 && (
          <div class="text-center py-8">
            <p class="text-gray-400">No {viewType === 'project' ? 'project' : 'client'} costs for this time period</p>
          </div>
        )}
      </div>
    )}

    <!-- Main Content Area -->
    <div class="bg-gray-800 rounded-lg shadow border border-gray-700 p-6">
      <div class="text-center py-12">
        <h3 class="text-lg font-medium text-white mb-2">Reports Coming Soon</h3>
        <p class="text-gray-400">This is a clean slate for building new reports and analytics features.</p>
      </div>
    </div>
  </div>

  <script is:inline>
    // Make functions globally available
    window.handlePeriodChange = function(period) {
      const customDateRange = document.getElementById('customDateRange');
      const viewSelect = document.getElementById('viewSelect');
      
      if (!customDateRange || !viewSelect) return;
      
      if (period === 'custom') {
        customDateRange.classList.remove('hidden');
        // Set default dates if not already set
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        
        if (startDate && !startDate.value) {
          const thirtyDaysAgo = new Date();
          thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
          startDate.value = thirtyDaysAgo.toISOString().split('T')[0];
        }
        if (endDate && !endDate.value) {
          endDate.value = new Date().toISOString().split('T')[0];
        }
      } else {
        customDateRange.classList.add('hidden');
        // Navigate to the selected period
        const teamMemberSelect = document.getElementById('teamMemberSelect');
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('period', period);
        currentUrl.searchParams.set('view', viewSelect.value);
        if (teamMemberSelect) {
          currentUrl.searchParams.set('teamMember', teamMemberSelect.value);
        }
        window.location.href = currentUrl.toString();
      }
    };

    window.applyCustomRange = function() {
      const startDateEl = document.getElementById('startDate');
      const endDateEl = document.getElementById('endDate');
      const viewSelect = document.getElementById('viewSelect');
      const teamMemberSelect = document.getElementById('teamMemberSelect');
      
      if (!startDateEl || !endDateEl || !viewSelect || !teamMemberSelect) return;
      
      const startDate = startDateEl.value;
      const endDate = endDateEl.value;
      
      if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert('Start date cannot be after end date');
        return;
      }
      
      window.location.href = `/admin/reports?period=custom&view=${viewSelect.value}&teamMember=${teamMemberSelect.value}&startDate=${startDate}&endDate=${endDate}`;
    };

    window.handleViewChange = function(view) {
      const periodSelect = document.getElementById('periodSelect');
      const teamMemberSelect = document.getElementById('teamMemberSelect');
      
      if (!periodSelect || !teamMemberSelect) return;
      
      const currentUrl = new URL(window.location);
      currentUrl.searchParams.set('period', periodSelect.value);
      currentUrl.searchParams.set('view', view);
      currentUrl.searchParams.set('teamMember', teamMemberSelect.value);
      
      // Preserve custom date range if it exists
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      if (startDate && endDate && startDate.value && endDate.value) {
        currentUrl.searchParams.set('startDate', startDate.value);
        currentUrl.searchParams.set('endDate', endDate.value);
      }
      
      window.location.href = currentUrl.toString();
    };

    window.handleTeamMemberChange = function(teamMember) {
      const periodSelect = document.getElementById('periodSelect');
      const viewSelect = document.getElementById('viewSelect');
      
      if (!periodSelect || !viewSelect) return;
      
      const currentUrl = new URL(window.location);
      currentUrl.searchParams.set('period', periodSelect.value);
      currentUrl.searchParams.set('view', viewSelect.value);
      currentUrl.searchParams.set('teamMember', teamMember);
      
      // Preserve custom date range if it exists
      const startDate = document.getElementById('startDate');
      const endDate = document.getElementById('endDate');
      if (startDate && endDate && startDate.value && endDate.value) {
        currentUrl.searchParams.set('startDate', startDate.value);
        currentUrl.searchParams.set('endDate', endDate.value);
      }
      
      window.location.href = currentUrl.toString();
    };

    // Initialize custom date range visibility on page load
    document.addEventListener('DOMContentLoaded', function() {
      const periodSelect = document.getElementById('periodSelect');
      const customDateRange = document.getElementById('customDateRange');
      
      if (periodSelect && customDateRange && periodSelect.value === 'custom') {
        customDateRange.classList.remove('hidden');
      }
    });
  </script>
</AdminLayout> 